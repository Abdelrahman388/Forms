{% extends "layout1.html" %}

{% block main %}

<!-- Floating Vertical Action Bar -->
<div id="floating-action-bar" class="vertical-action-bar">
  <div class="action-button-container">
    <button id="add-question-btn" class="action-button action-button-primary mb-3" title="Add Question">
      <i class="bi bi-plus-circle"></i>
      <span class="action-text">Add Question</span>
    </button>
    <button id="create-form-btn" class="action-button action-button-success" title="Save Form">
      <i class="bi bi-check-circle"></i>
      <span class="action-text">Save Form</span>
    </button>
  </div>
</div>

<div class="container" style="max-width: 1100px;">
  <!-- Form Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Details</h6>
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-4">
              <div class="form-floating mb-3">
                <input id="form-name" class="form-control w-100" type="text" name="name" required placeholder="">
                <label for="form-name">Form Name (for creator)</label>
              </div>
            </div>
            <div class="col-md-8">
              <div class="form-floating mb-3">
                <input id="form-title" class="form-control w-100" type="text" name="title" required placeholder="">
                <label for="form-title">Form Title (shown to responders)</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="form-floating mb-3">
                <textarea id="form-description" class="form-control" style="height: 100px;" name="description" placeholder=""></textarea>
                <label for="form-description">Form Description (shown to responders)</label>
              </div>
              <!-- <div class="form-check form-switch">
                <input id="form-restrict" class="form-check-input" type="checkbox">
                <label class="form-check-label" for="form-restrict">
                  Restrict to one response per person
                </label>
              </div> -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Questions Section -->
  <div id="questions-container"></div>

  <div id="no-questions-message" class="row">
    <div class="col-12">
      <div class="card border-info">
        <div class="card-body text-center">
          <h5 class="card-title text-muted">No Questions Yet</h5>
          <p class="card-text">Click "Add Question" to start building your form.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="static/css/action_bar.css">



<script>
let questions = [];
let questionIdCounter = 1;
let questionCounter = 1;

// Use form-specific sessionStorage key based on form ID

const formId = {{ form_data | safe }}.form_id || 'new';
const SESSION_STORAGE_KEY = `draftForm_${formId}`;

const sessionFormData = JSON.parse(sessionStorage.getItem(SESSION_STORAGE_KEY) || 'null');
const existingFormData = {{ form_data | safe }};

// Clear old draft sessions when switching forms
function clearOtherFormSessions() {
  const keys = Object.keys(sessionStorage);
  keys.forEach(key => {
    if (key.startsWith('draftForm_') && key !== SESSION_STORAGE_KEY) {
      sessionStorage.removeItem(key);
    }
  });
}

// Clear other form sessions when loading a different form
clearOtherFormSessions();

if (sessionFormData) {
  restoreFormFromSession(sessionFormData);
} else if (existingFormData && existingFormData.questions.length > 0) {
  restoreFormFromSession(existingFormData);
}


function restoreFormFromSession(data) {
  document.getElementById('form-name').value = data.name || '';
  document.getElementById('form-title').value = data.title || '';
  document.getElementById('form-description').value = data.description || '';
  // document.getElementById('form-restrict').checked = !!data.restrict;

  questions = data.questions.map(q => {
    const question = {
      id: q.id,
      text: q.text,
      answerType: q.answerType,
      options: q.options || null
    };
    renderQuestion(question);
    return question;
  });

  questionIdCounter = Math.max(...questions.map(q => q.id)) + 1;
  updateNoQuestionsMessage();

  saveToSession();
}

function saveToSession() {
  const formName = document.getElementById('form-name').value.trim();
  const formTitle = document.getElementById('form-title').value.trim();
  const formDescription = document.getElementById('form-description').value.trim();
  // const restrict = document.getElementById('form-restrict').checked;

  const formData = {
    form_id: formId,
    name: formName,
    title: formTitle,
    description: formDescription,
    // restrict: restrict,
    questions: questions
  };

  sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(formData));
}

function clearSession() {
  sessionStorage.removeItem(SESSION_STORAGE_KEY);
}

document.getElementById('form-name').addEventListener('input', saveToSession);
document.getElementById('form-title').addEventListener('input', saveToSession);
document.getElementById('form-description').addEventListener('input', saveToSession);
// document.getElementById('form-restrict').addEventListener('change', saveToSession);



function updateNoQuestionsMessage() {
  document.getElementById('no-questions-message').classList.toggle('d-none', questions.length > 0);
}

function createOptionHTML(qid, optionIndex) {
  return `
    <div class="input-group mb-2" data-option-index="${optionIndex}" style="max-width: 600px;">
      <input type="text" class="form-control option-input w-90" placeholder="Option text">
      <button class="btn btn-outline-danger remove-option-btn" type="button">
        <i class="bi bi-x"></i>
      </button>
    </div>
  `;
}

function renderQuestion(question) {
  const container = document.createElement('div');
  container.className = 'row mb-4';
  container.innerHTML = `
    <div class="col-12">
      <div class="card shadow-sm" data-qid="${question.id}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Question ${questionCounter}</h6>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary add-option-btn" style="display:none;" title="Add Option"><i class="bi bi-plus-circle"> Add Option</i></button>
            <button class="btn btn-outline-danger delete-btn" title="Delete Question"><i class="bi bi-trash"></i></button>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <div class="form-floating mb-3">
                <input type="text" class="form-control question-text w-100" placeholder="">
                <label>Question Text</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating mb-3">
                <select class="form-select answer-type">
                  <option value="text">Text</option>
                  <option value="radio">Multiple Choice</option>
                  <option value="checkbox">Checkbox</option>
                  <option value="dropdown">Dropdown</option>
                </select>
                <label>Answer Type</label>
              </div>
            </div>
          </div>
          <div class="option-container" style="display:none;"></div>
        </div>
      </div>
    </div>
  `;
    
  questionCounter++;
  const card = container.querySelector('.card');
  const qText = container.querySelector('.question-text');
  const answerType = container.querySelector('.answer-type');
  const optionContainer = container.querySelector('.option-container');
  const addOptionBtn = container.querySelector('.add-option-btn');

  qText.addEventListener('input', e => {
    question.text = e.target.value;
    saveToSession();
  });

  answerType.addEventListener('change', e => {
    question.answerType = e.target.value;
    if (['radio', 'checkbox','dropdown'].includes(e.target.value)) {
      optionContainer.style.display = 'block';
      addOptionBtn.style.display = 'inline-block';
      if (!Array.isArray(question.options)) question.options = [];
    } else {
      // Clear the options container when switching to text
      optionContainer.innerHTML = '';
      optionContainer.style.display = 'none';
      addOptionBtn.style.display = 'none';
      question.options = null;
    }
    saveToSession();
  });

  addOptionBtn.addEventListener('click', () => {
    const optionText = '';
    const opt = { id: Date.now(), text: optionText };
    question.options.push(opt);
    const index = question.options.length - 1;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = createOptionHTML(question.id, index);
    const input = wrapper.querySelector('.option-input');
    input.addEventListener('input', e => {
      opt.text = e.target.value;
      saveToSession();
    });
    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
      question.options.splice(index, 1);
      wrapper.remove();
      saveToSession();
    });
    optionContainer.appendChild(wrapper);
    saveToSession();
  });

  container.querySelector('.delete-btn').addEventListener('click', () => {
    questions = questions.filter(q => q.id !== question.id);
    container.remove();

    updateNoQuestionsMessage();
    saveToSession()
  });

  document.getElementById('questions-container').appendChild(container);
  updateNoQuestionsMessage();

    // Set initial values
  qText.value = question.text;
  answerType.value = question.answerType;

  // Trigger answerType change manually to toggle option fields
  answerType.dispatchEvent(new Event('change'));

  // If there are options, render them
  if (['radio', 'checkbox', 'dropdown'].includes(question.answerType) && Array.isArray(question.options)) {
    question.options.forEach((opt, index) => {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = createOptionHTML(question.id, index);
      const input = wrapper.querySelector('.option-input');
      input.value = opt.text;
      input.addEventListener('input', e => opt.text = e.target.value);
      wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
        question.options.splice(index, 1);
        wrapper.remove();
      });
      optionContainer.appendChild(wrapper);
    });
  }

  // When initializing a question, check if we need to show the add option button
  if (['radio', 'checkbox', 'dropdown'].includes(question.answerType)) {
    addOptionBtn.style.display = 'inline-block';
  }
}

// Add Question Event
document.getElementById('add-question-btn').addEventListener('click', () => {
  const newQuestion = { id: questionIdCounter++, text: '', answerType: 'text', options: null };
  questions.push(newQuestion);
  renderQuestion(newQuestion);
  saveToSession();
  
  // Scroll to the newly added question
  setTimeout(() => {
    const lastQuestion = document.querySelector('#questions-container .row:last-child');
    if (lastQuestion) {
      lastQuestion.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 100);
});

// Create Form Event Listener - Updated to use utils.js
document.getElementById('create-form-btn').addEventListener('click', async () => {
  console.log("Submitting Questions:", questions);
  const formName = document.getElementById('form-name').value.trim();
  const formTitle = document.getElementById('form-title').value.trim();
  const formDescription = document.getElementById('form-description').value.trim();
  // const restrict = document.getElementById('form-restrict').checked;

  if (!formName || !formTitle) {
    showError('Please fill in both form name and title');
    return;
  }

  const payload = {
    name: formName,
    title: formTitle,
    description: formDescription,
    // restrict: restrict,
    questions: questions
  };

  try {
    const response = await makeRequest('/create', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (result.success) {
      clearSession();
      showSuccess('Form created successfully!');
      setTimeout(() => {
        window.location.href = '/';
      }, 1500);
    } else {
      showError('Failed to create form: ' + result.error);
    }
  } catch (error) {
    console.error('Error creating form:', error);
    showError('An error occurred while creating the form');
  }
});

window.history.pushState({}, '');

// Back Button Event: Clear sessionStorage for this specific form
window.addEventListener('popstate', clearSession);

window.addEventListener('pageshow', function(event) {
  if (event.persisted) {
    clearSession();
  }
});

// Keep only the hover effect for slight visual feedback
document.getElementById('floating-action-bar').addEventListener('mouseenter', function() {
  this.style.transform = 'translateY(-50%) scale(1.05)';
});

document.getElementById('floating-action-bar').addEventListener('mouseleave', function() {
  this.style.transform = 'translateY(-50%)';
});

</script>
{% endblock %}
